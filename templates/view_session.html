{% extends "base.html" %}

{% block title %}Attendance Session - {{ class_obj.name }}{% endblock %}

{% block content %}
<div class="session-detail">
    <div class="session-header">
        <h1>Attendance Session</h1>
        <p>{{ class_obj.name }} ({{ class_obj.code }})</p>
        <p class="session-date">{{ session.date.strftime('%B %d, %Y at %I:%M %p') }}</p>
        {% if session.is_active %}
            <span class="badge badge-success">Active</span>
        {% else %}
            <span class="badge badge-secondary">Closed</span>
        {% endif %}
    </div>

    {% if session.is_active %}
        <div class="qr-section">
            <h2><i class="fas fa-qrcode"></i> Scan to Check In</h2>
            <p style="margin-bottom: 1.5rem;">Students should scan this QR code to mark their attendance.</p>
            <div class="qr-code-container">
                <!-- Primary QR Code from app -->
                <img
                    src="{{ url_for('generate_qr', session_id=session.id) }}"
                    alt="QR Code"
                    onerror="this.onerror=null; this.src='https://api.qrserver.com/v1/create-qr-code/?size=300x300&data={{ request.url_root }}check_in?token={{ session.qr_token }}'; this.style.padding='10px';"
                    style="max-width: 300px; height: auto;">
            </div>
            <p class="qr-url"><i class="fas fa-link"></i> Or visit: <a href="{{ request.url_root }}check_in?token={{ session.qr_token }}" target="_blank" style="color: var(--primary-color); word-break: break-all;">{{ request.url_root }}check_in?token={{ session.qr_token }}</a></p>
            <form method="POST" action="{{ url_for('close_session', session_id=session.id) }}" onsubmit="return confirm('Close this session? All remaining students will be marked absent.');" style="margin-top: 2rem;">
                {{ csrf_token() }}
                <button type="submit" class="btn btn-danger">
                    <i class="fas fa-stop-circle"></i> Close Session
                </button>
            </form>
        </div>
    {% endif %}

    <div class="attendance-summary">
        <h2><i class="fas fa-chart-bar"></i> Attendance Record</h2>
        <div class="summary-stats">
            <div class="stat-card">
                <h3>{{ records|selectattr('status', 'equalto', 'Present')|list|length }}</h3>
                <p><i class="fas fa-check-circle"></i> Present</p>
            </div>
            <div class="stat-card">
                <h3>{{ records|selectattr('status', 'equalto', 'Late')|list|length }}</h3>
                <p><i class="fas fa-clock"></i> Late</p>
            </div>
            <div class="stat-card">
                <h3>{% if session.is_active %}{{ all_students|length - records|length }}{% else %}{{ records|selectattr('status', 'equalto', 'Absent')|list|length }}{% endif %}</h3>
                <p><i class="fas fa-times-circle"></i> {% if session.is_active %}Waiting{% else %}Absent{% endif %}</p>
            </div>
            <div class="stat-card">
                <h3>{{ all_students|length }}</h3>
                <p><i class="fas fa-users"></i> Total Students</p>
            </div>
        </div>
    </div>

    <div class="attendance-list">
        <h3>Student Details</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Student ID</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Time</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for student in all_students %}
                    {% if student.is_pending %}
                        {% set record = records|selectattr('student_email', 'equalto', student.email)|first %}
                        <tr>
                            <td>
                                {% if student.name %}
                                    {{ student.name }}
                                {% else %}
                                    <em style="color: var(--text-secondary);">Not Registered</em>
                                {% endif %}
                            </td>
                            <td>N/A</td>
                            <td>{{ student.email }}</td>
                            <td>
                                {% if record %}
                                    {% if record.status == 'Present' %}
                                        <span class="status-pill status-pill-present"><i class="fas fa-check-circle"></i> Present</span>
                                    {% elif record.status == 'Late' %}
                                        <span class="status-pill status-pill-late"><i class="fas fa-clock"></i> Late</span>
                                    {% else %}
                                        <span class="status-pill status-pill-absent"><i class="fas fa-times-circle"></i> Absent</span>
                                    {% endif %}
                                {% elif not session.is_active %}
                                    <span class="status-pill status-pill-absent"><i class="fas fa-times-circle"></i> Absent</span>
                                {% else %}
                                    <span class="badge badge-warning">Waiting</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if record %}
                                    {{ record.timestamp.strftime('%I:%M %p') }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                <form method="POST" action="{{ url_for('edit_attendance_record', session_id=session.id) }}" style="display: inline;">
                                    {{ csrf_token() }}
                                    <input type="hidden" name="student_email" value="{{ student.email }}">
                                    <select name="status" onchange="this.form.submit()" class="status-select" {% if session.is_active %}disabled{% endif %}>
                                        <option value="Present" {% if record and record.status == 'Present' %}selected{% endif %}>Present</option>
                                        <option value="Late" {% if record and record.status == 'Late' %}selected{% endif %}>Late</option>
                                        <option value="Absent" {% if not record or record.status == 'Absent' %}selected{% endif %}>Absent</option>
                                    </select>
                                </form>
                            </td>
                        </tr>
                    {% else %}
                        {% set record = records|selectattr('student_id', 'equalto', student.user.id)|first %}
                        <tr>
                            <td>{{ student.user.name }}</td>
                            <td>{{ student.user.student_id or 'N/A' }}</td>
                            <td>{{ student.user.email }}</td>
                            <td>
                                {% if record %}
                                    {% if record.status == 'Present' %}
                                        <span class="status-pill status-pill-present"><i class="fas fa-check-circle"></i> Present</span>
                                    {% elif record.status == 'Late' %}
                                        <span class="status-pill status-pill-late"><i class="fas fa-clock"></i> Late</span>
                                    {% else %}
                                        <span class="status-pill status-pill-absent"><i class="fas fa-times-circle"></i> Absent</span>
                                    {% endif %}
                                {% elif not session.is_active %}
                                    <span class="status-pill status-pill-absent"><i class="fas fa-times-circle"></i> Absent</span>
                                {% else %}
                                    <span class="badge badge-warning">Waiting</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if record %}
                                    {{ record.timestamp.strftime('%I:%M %p') }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                <form method="POST" action="{{ url_for('edit_attendance_record', session_id=session.id) }}" style="display: inline;">
                                    {{ csrf_token() }}
                                    <input type="hidden" name="student_id" value="{{ student.user.id }}">
                                    <select name="status" onchange="this.form.submit()" class="status-select" {% if session.is_active %}disabled{% endif %}>
                                        <option value="Present" {% if record and record.status == 'Present' %}selected{% endif %}>Present</option>
                                        <option value="Late" {% if record and record.status == 'Late' %}selected{% endif %}>Late</option>
                                        <option value="Absent" {% if not record or record.status == 'Absent' %}selected{% endif %}>Absent</option>
                                    </select>
                                </form>
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="back-link">
        <a href="{{ url_for('view_class', class_id=class_obj.id) }}">‚Üê Back to Class</a>
    </div>
</div>

{% if session.is_active %}
<script>
// Auto-refresh the page every 5 seconds when session is active
let autoRefreshInterval;
let refreshCountdown = 5;
let isPaused = false;

// Create refresh indicator
const refreshIndicator = document.createElement('div');
refreshIndicator.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-size: 14px;
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
`;
refreshIndicator.innerHTML = `
    <i class="fas fa-sync-alt" style="animation: spin 2s linear infinite;"></i>
    <span id="refreshText">Auto-refresh in <strong id="countdown">5</strong>s</span>
    <button id="pauseBtn" style="
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        padding: 4px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
    ">
        <i class="fas fa-pause"></i> Pause
    </button>
`;
document.body.appendChild(refreshIndicator);

// Add spin animation
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);

// Countdown and refresh logic
function startCountdown() {
    const countdownEl = document.getElementById('countdown');
    const refreshTextEl = document.getElementById('refreshText');

    autoRefreshInterval = setInterval(() => {
        if (!isPaused) {
            refreshCountdown--;
            countdownEl.textContent = refreshCountdown;

            if (refreshCountdown <= 0) {
                refreshTextEl.innerHTML = '<strong>Refreshing...</strong>';
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            }
        }
    }, 1000);
}

// Pause/Resume functionality
document.getElementById('pauseBtn').addEventListener('click', (e) => {
    e.stopPropagation();
    isPaused = !isPaused;
    const pauseBtn = document.getElementById('pauseBtn');
    const refreshTextEl = document.getElementById('refreshText');

    if (isPaused) {
        pauseBtn.innerHTML = '<i class="fas fa-play"></i> Resume';
        refreshTextEl.innerHTML = '<strong>Auto-refresh paused</strong>';
        refreshIndicator.style.background = 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)';
    } else {
        pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
        refreshCountdown = 5;
        refreshTextEl.innerHTML = 'Auto-refresh in <strong id="countdown">5</strong>s';
        refreshIndicator.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    }
});

// Click to refresh immediately
refreshIndicator.addEventListener('click', (e) => {
    if (e.target.id !== 'pauseBtn' && !isPaused) {
        window.location.reload();
    }
});

// Start countdown
startCountdown();

// Show a subtle notification when new attendance is detected (visual feedback)
const originalTitle = document.title;
let titleInterval;

// Flash the title to get teacher's attention when page is in background
function flashTitle() {
    let isOriginal = true;
    titleInterval = setInterval(() => {
        document.title = isOriginal ? 'üîî New Check-in!' : originalTitle;
        isOriginal = !isOriginal;
    }, 1000);
}

// Stop flashing when page is focused
window.addEventListener('focus', () => {
    if (titleInterval) {
        clearInterval(titleInterval);
        document.title = originalTitle;
    }
});
</script>
{% endif %}

{% endblock %}