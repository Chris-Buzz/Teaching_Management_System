{% extends "base.html" %}

{% block title %}Attendance Report - {{ class_obj.name }}{% endblock %}

{% block content %}
<div class="history-detail">
    <div style="margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <a href="{{ url_for('view_class', class_id=class_obj.id) }}" style="color: var(--primary-color); text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-arrow-left"></i> Back to {{ class_obj.name }}
            </a>
        </div>
    </div>

    <div style="text-align: center; margin-bottom: 2.5rem; padding-bottom: 2rem; border-bottom: 2px solid var(--border-color);">
        <h1 style="margin-bottom: 0.5rem;">
            <i class="fas fa-chart-bar" style="color: var(--primary-color);"></i> Attendance Report
        </h1>
        <p style="color: var(--text-secondary); margin: 0.5rem 0;">
            {{ class_obj.name }} ({{ class_obj.code }})
        </p>
        <p style="color: var(--text-secondary); font-size: 0.95rem;">
            <i class="fas fa-calendar-alt"></i> Total Sessions: <strong>{{ total_sessions }}</strong>
        </p>
    </div>

    <div class="attendance-summary" style="margin-bottom: 2.5rem;">
        <h2 style="margin-bottom: 1.5rem;"><i class="fas fa-list"></i> Student Attendance Overview</h2>
        
        {% if student_stats %}
            <div class="report-table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Student ID</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th style="text-align: center;">Present</th>
                            <th style="text-align: center;">Late</th>
                            <th style="text-align: center;">Absent</th>
                            <th style="text-align: center;">Attendance Rate</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in student_stats %}
                            <tr style="animation: slideInUp 0.5s ease-out backwards; animation-delay: {{ loop.index0 * 0.05 }}s;">
                                <td>
                                    <strong>{{ student.name }}</strong>
                                </td>
                                <td>
                                    {% if student.student_id %}
                                        {{ student.student_id }}
                                    {% else %}
                                        <span style="color: var(--text-secondary);">â€”</span>
                                    {% endif %}
                                </td>
                                <td style="font-size: 0.9rem; color: var(--text-secondary);">
                                    {{ student.email }}
                                </td>
                                <td>
                                    {% if student.status == 'Registered' %}
                                        <span class="badge" style="background-color: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3);">
                                            <i class="fas fa-check-circle"></i> Registered
                                        </span>
                                    {% else %}
                                        <span class="badge" style="background-color: rgba(245, 158, 11, 0.1); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3);">
                                            <i class="fas fa-clock"></i> Pending
                                        </span>
                                    {% endif %}
                                </td>
                                <td style="text-align: center;">
                                    <span style="background: rgba(16, 185, 129, 0.1); color: #10b981; padding: 0.4rem 0.8rem; border-radius: 8px; font-weight: 600; display: inline-block;">
                                        {{ student.present_count }}
                                    </span>
                                </td>
                                <td style="text-align: center;">
                                    <span style="background: rgba(245, 158, 11, 0.1); color: #f59e0b; padding: 0.4rem 0.8rem; border-radius: 8px; font-weight: 600; display: inline-block;">
                                        {{ student.late_count }}
                                    </span>
                                </td>
                                <td style="text-align: center;">
                                    <span style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 0.4rem 0.8rem; border-radius: 8px; font-weight: 600; display: inline-block;">
                                        {{ student.absent_count }}
                                    </span>
                                </td>
                                <td style="text-align: center;">
                                    <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                        <div style="width: 40px; height: 40px; border-radius: 50%; background: conic-gradient(
                                            {% if student.attendance_rate >= 80 %}
                                                #10b981
                                            {% elif student.attendance_rate >= 60 %}
                                                #f59e0b
                                            {% else %}
                                                #ef4444
                                            {% endif %} 0deg {{ student.attendance_rate * 3.6 }}deg,
                                            rgba(0,0,0,0.1) {{ student.attendance_rate * 3.6 }}deg
                                        ); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem; color: var(--text-primary);">
                                            {{ student.attendance_rate }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if student.user_id %}
                                        <a href="{{ url_for('student_attendance_history', class_id=class_obj.id, student_id=student.user_id) }}" class="btn btn-primary btn-xs" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                                            <i class="fas fa-eye"></i> View
                                        </a>
                                    {% else %}
                                        <a href="{{ url_for('pending_student_attendance_history', class_id=class_obj.id, email=student.email.lower()) }}" class="btn btn-primary btn-xs" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                                            <i class="fas fa-eye"></i> View
                                        </a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(0, 102, 204, 0.05); border-left: 4px solid var(--primary-color); border-radius: 8px;">
                <h3 style="margin-bottom: 1rem; color: var(--primary-color);"><i class="fas fa-info-circle"></i> Summary Statistics</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Total Students</p>
                        <p style="font-size: 1.8rem; font-weight: 700; color: var(--primary-color);">{{ student_stats|length }}</p>
                    </div>
                    <div>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Average Attendance</p>
                        <p style="font-size: 1.8rem; font-weight: 700; color: #10b981;">
                            {% if student_stats %}
                                {{ "%.1f"|format(student_stats|map(attribute='attendance_rate')|sum / student_stats|length) }}%
                            {% else %}
                                0%
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Total Sessions Held</p>
                        <p style="font-size: 1.8rem; font-weight: 700; color: #0ea5e9;">{{ total_sessions }}</p>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-inbox" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem;"></i>
                <p>No students enrolled in this class yet.</p>
            </div>
        {% endif %}
    </div>

    <style>
        .report-table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            animation: slideInUp 0.6s ease-out;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .data-table thead {
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.05) 0%, rgba(99, 102, 241, 0.05) 100%);
            border-bottom: 2px solid var(--border-color);
        }

        .data-table thead th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .data-table tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: all var(--transition-base);
        }

        .data-table tbody tr:hover {
            background: rgba(0, 102, 204, 0.02);
        }

        .data-table tbody td {
            padding: 1rem;
            font-size: 0.95rem;
            vertical-align: middle;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .btn-xs {
            padding: 0.4rem 0.8rem !important;
            font-size: 0.8rem !important;
            white-space: nowrap;
        }
    </style>
</div>
{% endblock %}
